"use strict";(self.webpackChunkphasetwo_docs=self.webpackChunkphasetwo_docs||[]).push([[1679],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return d}});var a=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),h=p(n),d=o,m=h["".concat(s,".").concat(d)]||h[d]||u[d]||i;return n?a.createElement(m,r(r({ref:t},c),{},{components:n})):a.createElement(m,r({ref:t},c))}));function d(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,r=new Array(i);r[0]=h;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:o,r[1]=l;for(var p=2;p<i;p++)r[p]=n[p];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},9392:function(e,t,n){n.r(t),n.d(t,{assets:function(){return c},contentTitle:function(){return s},default:function(){return d},frontMatter:function(){return l},metadata:function(){return p},toc:function(){return u}});var a=n(83117),o=n(80102),i=(n(67294),n(3905)),r=["components"],l={slug:"securing-apps-with-keycloak",title:"Protecting Your Application With Keycloak",author:"Phase Two",tags:["tutorial","keycloak","phase_two"]},s=void 0,p={permalink:"/blog/securing-apps-with-keycloak",source:"@site/blog/2022-10-17-securing-apps-with-keycloak.md",title:"Protecting Your Application With Keycloak",description:"There are a lot of guides out there, official and unofficial, for how to secure applications with Keycloak. The subject is rather broad, so it's difficult to know where to start. To begin, we'll be focusing on Keycloak's use of OpenID Connect (OIDC), and how to use that standard, along with some helpful libraries, to secure a simple but instructive application.",date:"2022-10-17T00:00:00.000Z",formattedDate:"October 17, 2022",tags:[{label:"tutorial",permalink:"/blog/tags/tutorial"},{label:"keycloak",permalink:"/blog/tags/keycloak"},{label:"phase_two",permalink:"/blog/tags/phase-two"}],readingTime:5.9,hasTruncateMarker:!1,authors:[{name:"Phase Two"}],frontMatter:{slug:"securing-apps-with-keycloak",title:"Protecting Your Application With Keycloak",author:"Phase Two",tags:["tutorial","keycloak","phase_two"]},prevItem:{title:"Setting up SSO with Phase Two",permalink:"/blog/sso-setup"},nextItem:{title:"Magic Links Guide, and 5 Minute Setup",permalink:"/blog/set-up-magic-links"}},c={authorsImageUrls:[void 0]},u=[{value:"What is OIDC?",id:"what-is-oidc",level:3},{value:"Login flow",id:"login-flow",level:3},{value:"Setup",id:"setup",level:3},{value:"Client",id:"client",level:3},{value:"Make a user",id:"make-a-user",level:3},{value:"Running the sample apps",id:"running-the-sample-apps",level:3},{value:"Putting it all together",id:"putting-it-all-together",level:3},{value:"What just happened?",id:"what-just-happened",level:3},{value:"Your application",id:"your-application",level:3}],h={toc:u};function d(e){var t=e.components,l=(0,o.Z)(e,r);return(0,i.kt)("wrapper",(0,a.Z)({},h,l,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"There are a lot of guides out there, official and unofficial, for how to secure applications with Keycloak. The subject is rather broad, so it's difficult to know where to start. To begin, we'll be focusing on Keycloak's use of OpenID Connect (OIDC), and how to use that standard, along with some helpful libraries, to secure a simple but instructive application. "),(0,i.kt)("p",null,"For the purposes of the sample, we'll actually be using two common applications, a frontend single-page application (SPA) written in JavaScript, and a backend REST API written for Node.js. The language we selected for the sample is JavaScript, but the principles apply no matter the implementation technology you choose."),(0,i.kt)("h3",{id:"what-is-oidc"},"What is OIDC?"),(0,i.kt)("p",null,"When learning about identity and access management technologies, you'll be confronted with an alphabet-soup of acronyms to learn. OIDC, or OpenID Connect is one of the most important ones for securing applications, be it browser-based, APIs, mobile or native. Our friend over at OneLogin does a great job of explaining ",(0,i.kt)("a",{parentName:"p",href:"https://www.onelogin.com/blog/openid-connect-explained-in-plain-english-2"},"OIDC in plain english")," for those that are curious."),(0,i.kt)("p",null,"For the purpose of this guide, it is sufficient to know that OIDC is an open authentication protocol that works on top of the OAuth 2.0 framework. OIDC allows individuals to use single sign-on (SSO) to access relying party sites using OpenID Providers (OPs), such as an email provider or social network, to authenticate their identities. It provides the application or service with information about the user, the context of their authentication, and access to their profile information."),(0,i.kt)("h3",{id:"login-flow"},"Login flow"),(0,i.kt)("p",null,'A "flow" in OIDC terms is a mechanism of authenticating a user, and obtaning access tokens. The flow we\'ll be using in this guide is called the authorization code flow. Fortunately, the internals of the flow are not necessary to understand, as Keycloak handles the details for you. '),(0,i.kt)("p",null,"However, it is useful to see what is going on in the login process, so that you understand your user's experience."),(0,i.kt)("p",null,(0,i.kt)("img",{src:n(69740).Z,width:"764",height:"507"})),(0,i.kt)("h3",{id:"setup"},"Setup"),(0,i.kt)("p",null,"We'll make an assumption for this guide that you are using a cloud deployment of Phase Two enhanced Keycloak. If you haven't already set one up, go over to the ",(0,i.kt)("a",{parentName:"p",href:"/blog/self-service"},"self-service launch announcement")," for details. You may also use your own Keycloak setup, but that setup is beyond the scope of this article."),(0,i.kt)("p",null,"The sample applications are available in our ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/p2-inc/debug-app"},"demo repo")," on Github. Clone that repo to your local machine. You'll find the applications in the ",(0,i.kt)("inlineCode",{parentName:"p"},"frontend")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"backend")," directory, and a set of supporting files for configuration and deployment."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"git clone https://github.com/p2-inc/debug-app.git\ncd debug-app\n")),(0,i.kt)("h3",{id:"client"},"Client"),(0,i.kt)("p",null,"Every application that Keycloak protects is considered a ",(0,i.kt)("strong",{parentName:"p"},"Client"),". Log into your Keycloak realm, and click on ",(0,i.kt)("strong",{parentName:"p"},"Clients")," in the left navigation, and click ",(0,i.kt)("em",{parentName:"p"},"Create client"),". "),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Enter ",(0,i.kt)("inlineCode",{parentName:"li"},"frontend")," as the ",(0,i.kt)("strong",{parentName:"li"},"Client ID")," and click ",(0,i.kt)("em",{parentName:"li"},"Next")),(0,i.kt)("li",{parentName:"ol"},"In the ",(0,i.kt)("strong",{parentName:"li"},"Capability config")," screen, keep the defaults and click ",(0,i.kt)("em",{parentName:"li"},"Save")),(0,i.kt)("li",{parentName:"ol"},"In the ",(0,i.kt)("strong",{parentName:"li"},"Access settings")," screen, enter the following values:",(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"http://localhost:3001/*")," for ",(0,i.kt)("strong",{parentName:"li"},"Valid redirect URIs")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"+")," in ",(0,i.kt)("strong",{parentName:"li"},"Valid post logout redirect URIs")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"+")," in ",(0,i.kt)("strong",{parentName:"li"},"Web origins")))),(0,i.kt)("li",{parentName:"ol"},"Click ",(0,i.kt)("em",{parentName:"li"},"Save")),(0,i.kt)("li",{parentName:"ol"},"In the upper right corner, open the ",(0,i.kt)("strong",{parentName:"li"},"Action")," menu and select ",(0,i.kt)("strong",{parentName:"li"},"Download adapter config"),". Click ",(0,i.kt)("em",{parentName:"li"},"Download")," and move the file to the ",(0,i.kt)("inlineCode",{parentName:"li"},"debug-app")," repo you cloned under the ",(0,i.kt)("inlineCode",{parentName:"li"},"frontend")," folder.")),(0,i.kt)("p",null,(0,i.kt)("img",{src:n(7102).Z,width:"1102",height:"1106"})),(0,i.kt)("h3",{id:"make-a-user"},"Make a user"),(0,i.kt)("p",null,"Before we run the application, we need to create a user to log in. Click on ",(0,i.kt)("strong",{parentName:"p"},"Users")," in the left navigation, and click ",(0,i.kt)("em",{parentName:"p"},"Add user"),". You only need to give the user a username and click ",(0,i.kt)("em",{parentName:"p"},"Create"),". Find the ",(0,i.kt)("strong",{parentName:"p"},"Credentials")," tab and click ",(0,i.kt)("strong",{parentName:"p"},"Set password")," to give the user a password."),(0,i.kt)("h3",{id:"running-the-sample-apps"},"Running the sample apps"),(0,i.kt)("p",null,"Open two terminal windows and go to the directory of the repo you cloned in both. To start, run the following commands in each terminal:"),(0,i.kt)("p",null,"Frontend:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"cd frontend/\nnpm install\nnpm start\n")),(0,i.kt)("p",null,"Backend:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"cd backend/\nnpm install\nKC_REALM=<your-realm-name> KC_URL=<your-keycloak-url> npm start\n")),(0,i.kt)("p",null,"Be sure to replace the realm name, and the URL of your Keycloak installation (e.g. ",(0,i.kt)("inlineCode",{parentName:"p"},"https://usw2.auth.ac/auth/"),")."),(0,i.kt)("p",null,"This will install the necessary components using npm, and will start the servers for both applications. Note: the applications use ports 3001 and 3002 by default. If you have other applications running on these ports, you may have to temporarily shut them down."),(0,i.kt)("h3",{id:"putting-it-all-together"},"Putting it all together"),(0,i.kt)("p",null,"Load ",(0,i.kt)("a",{href:"http://localhost:3001/",target:"_blank"},"http://localhost:3001/")," in your browser. This will load the frontend application, which will be immediately redirected to the Keycloak login page. Log in with the user you created."),(0,i.kt)("p",null,"Once you log in, you'll see your profile, and several menu items. First click to the ",(0,i.kt)("strong",{parentName:"p"},"Access token")," menu item. You'll see the information from the parsed access token that was returned by Keycloak. This contains information about the user, but also claims related to the users roles and groups. This is because access tokens are meant to be read and validated by resource servers (i.e. our backend service)."),(0,i.kt)("p",null,"Next, click ",(0,i.kt)("strong",{parentName:"p"},"ID token"),". You'll see similar information to what we saw in the access token, but limited to a standardized set of information that identifies the authentication state of the user. ID tokens are not meant for calling resource servers, and because of that, don't contain claims that are meant to be validated by backend services."),(0,i.kt)("p",null,"Clicking ",(0,i.kt)("strong",{parentName:"p"},"Service")," will call the backend service. You'll see a message that indicates the frontend called the backend, passing the access token, and was authorized to access a secured service. "),(0,i.kt)("p",null,"You can also try the built-in Keycloak Account Management console by clicking ",(0,i.kt)("strong",{parentName:"p"},"Account"),", which gives the user a simple way to manage their information that is stored in Keycloak. It is not necessary to use this with your applications, as you may choose to build it in to your app. However, it's a good tool to have out of the box."),(0,i.kt)("p",null,"Finally, clicking ",(0,i.kt)("strong",{parentName:"p"},"Logout")," will take you back to the login page. This is actually sending you to the frontend's initial page, which is redirecting you to the login page as its default behavior."),(0,i.kt)("iframe",{width:"560",height:"315",src:"https://www.youtube.com/embed/Wi9qipIDi4w",title:"YouTube video player",frameborder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowfullscreen:!0}),(0,i.kt)("h3",{id:"what-just-happened"},"What just happened?"),(0,i.kt)("p",null,"There's a lot that goes into implementation of the OIDC flow we used to secure our sample applications. Part of the reason to use Keycloak is the mature implementation and client libraries that make protecting applications in a secure way almost trivial. "),(0,i.kt)("p",null,"We encourage you to look at the source in the sample applications (specifically ",(0,i.kt)("inlineCode",{parentName:"p"},"frontend/app.js")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"backend/app.js"),") and observe how the Keycloak client libraries are used to secure these applications. This will be a good place to start when you are working on securing your own applications."),(0,i.kt)("h3",{id:"your-application"},"Your application"),(0,i.kt)("p",null,"Another incredible advantage to using standards like OIDC is that you are not constrained to using Keycloak libraries. Because your applications may not be written in JavaScript also, it's easy to use other language OIDC client libraries. We maintain a ",(0,i.kt)("a",{parentName:"p",href:"/docs/securing-applications/#libraries"},"list of OIDC libraries"),", and the ",(0,i.kt)("a",{parentName:"p",href:"https://openid.net/"},"OpenID Foundation")," also maintains lists of ",(0,i.kt)("a",{parentName:"p",href:"https://openid.net/developers/certified/"},"certified")," and ",(0,i.kt)("a",{parentName:"p",href:"https://openid.net/developers/uncertified/"},"uncertified")," implementations"),(0,i.kt)("p",null,"Today you saw how to quickly secure an application using Keycloak, and learned more about the underlying OIDC standards. We look forward to seeing what you build!"))}d.isMDXComponent=!0},69740:function(e,t,n){t.Z=n.p+"assets/images/2022-10-17-authentication-flow-ed76f7cb6dbf73f59f0941f1bac76470.png"},7102:function(e,t,n){t.Z=n.p+"assets/images/2022-10-17-client-setup-206620dc405420cabc1b0eb5e7866844.png"}}]);