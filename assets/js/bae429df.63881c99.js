"use strict";(self.webpackChunkphasetwo_docs=self.webpackChunkphasetwo_docs||[]).push([[5758],{12776:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/create_shared_deployment-a4fc0584f6318f037cf191e06c9703b8.png"},28453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>a});var i=t(96540);const r={},s=i.createContext(r);function o(e){const n=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),i.createElement(s.Provider,{value:n},e.children)}},28993:e=>{e.exports=JSON.parse('{"permalink":"/blog/secure-spring-boot","source":"@site/blog/2024-05-09-secure-spring-boot.mdx","title":"Securing an Angular and Spring Boot Application with Keycloak","description":"Learn how to secure resources and access of an Angular and Spring Boot application using Keycloak for Authentication and Authorizationusing the open source IAMs Keycloak for Authentication and Authorization","date":"2024-05-09T00:00:00.000Z","tags":[{"inline":true,"label":"phase_two","permalink":"/blog/tags/phase-two"},{"inline":true,"label":"tutorial","permalink":"/blog/tags/tutorial"},{"inline":true,"label":"frameworks","permalink":"/blog/tags/frameworks"},{"inline":true,"label":"spring_boot","permalink":"/blog/tags/spring-boot"},{"inline":true,"label":"authentication","permalink":"/blog/tags/authentication"},{"inline":true,"label":"authorization","permalink":"/blog/tags/authorization"},{"inline":true,"label":"sso","permalink":"/blog/tags/sso"}],"readingTime":2.2,"hasTruncateMarker":true,"authors":[{"name":"Phase Two","title":"Hosted Keycloak and Keycloak Support","url":"https://github.com/p2-inc","email":"support@phasetwo.io","imageURL":"https://avatars.githubusercontent.com/u/60152109?s=200&v=4","key":"phasetwo","page":null}],"frontMatter":{"slug":"secure-spring-boot","title":"Securing an Angular and Spring Boot Application with Keycloak","description":"Learn how to secure resources and access of an Angular and Spring Boot application using Keycloak for Authentication and Authorizationusing the open source IAMs Keycloak for Authentication and Authorization","authors":"phasetwo","tags":["phase_two","tutorial","frameworks","spring_boot","authentication","authorization","sso"],"image":"/blog/og/springboot@2x.png"},"unlisted":false,"prevItem":{"title":"Phase Two\'s Organizations, a Keycloak Multi-Tenant Extension and Keycloak\'s Upcoming Organization\'s Feature","permalink":"/blog/organgizations-multi-tenant-update"},"nextItem":{"title":"Keycloak vs. Auth0, an Open-Source Alternative","permalink":"/blog/keycloak-vs-auth0-open-source-alternative"}}')},31049:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/copy-credential-c9822fe7c52d15c588ca6661aa2416fd.png"},32991:(e,n,t)=>{t.d(n,{Ay:()=>a,RM:()=>s});var i=t(74848),r=t(28453);const s=[{value:"OIDC Config",id:"oidc-config",level:3}];function o(e){const n={a:"a",code:"code",em:"em",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components},{Details:s}=n;return s||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.p,{children:["We need to create a ",(0,i.jsx)(n.a,{href:"https://www.keycloak.org/docs/latest/server_admin/#con-oidc_server_administration_guide",children:"OpenID Connect"})," Client in Keycloak for the app to communicate with. Keycloak's ",(0,i.jsx)(n.a,{href:"https://www.keycloak.org/docs/latest/server_admin/#_oidc_clients",children:"docs"})," provide steps for how to create an OIDC client and all the various configurations that can be introduced. Follow the steps below to create a client and get the right information necessary for app configuration."]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Open the Admin UI by clicking ",(0,i.jsx)(n.strong,{children:"Open Console"})," in the Phase Two Dashboard."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Click ",(0,i.jsx)(n.strong,{children:"Clients"})," in the menu."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Click ",(0,i.jsx)(n.strong,{children:"Create client"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Leave ",(0,i.jsx)(n.strong,{children:"Client type"})," set to ",(0,i.jsx)(n.strong,{children:"OpenID Connect"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Enter a ",(0,i.jsx)(n.strong,{children:"Client ID"}),". This ID is an alphanumeric string that is used in OIDC requests and in the Keycloak database to identify the client."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Supply a ",(0,i.jsx)(n.strong,{children:"Name"})," for the client."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Click ",(0,i.jsx)(n.strong,{children:"Next"}),"."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Keycloak OIDC Create Client General Settings",src:t(35450).A+"",width:"3000",height:"2072"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Under the Capability Config section, leave the defaults as selected. This can be configured further later."}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Client authentication to On."}),"\n",(0,i.jsx)(n.li,{children:"Authorization to Off."}),"\n",(0,i.jsx)(n.li,{children:"Standard flow checked. Direct access grants checked. All other items unchecked."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Keycloak OIDC Create Client Capability Config with Authentication",src:t(47475).A+"",width:"3000",height:"1909"})}),"\n",(0,i.jsxs)(n.p,{children:["Click ",(0,i.jsx)(n.strong,{children:"Next"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Under Login settings we need to add a redirect URI and Web origin in order. Assuming you are using the example applicaiton:"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.em,{children:"Valid redirect URI"})," (allows redirect back to application)"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"http://localhost:3000/*\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.em,{children:"Web origins"})," (allows for Token auth call)"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"http://localhost:3000\n"})}),"\n",(0,i.jsxs)(s,{children:[(0,i.jsx)("summary",{children:"URI and Origin Details"}),(0,i.jsxs)(n.p,{children:["The choice of ",(0,i.jsx)(n.code,{children:"localhost"})," is arbitrary. If you are using an example application running locally, this will apply. If you are using an app that you actually have deployed somewhere, then you will need to substitute the appropriate URI for that."]})]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Click ",(0,i.jsx)(n.strong,{children:"Save"})]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Keycloak OIDC Create Login Settings",src:t(40623).A+"",width:"3000",height:"2074"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"oidc-config",children:"OIDC Config"}),"\n",(0,i.jsx)(n.p,{children:"We will need values to configure our application. To get these values follow the instructions below."}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Click ",(0,i.jsx)(n.strong,{children:"Clients"})," in the menu."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Find the Client you just created and click on it. In the top right click the ",(0,i.jsx)(n.strong,{children:"Action"})," dropdown and select ",(0,i.jsx)(n.strong,{children:"Download adapter config"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Select ",(0,i.jsx)(n.strong,{children:"Keycloak OIDC JSON"})," in the format option. The details section will populate with the details we will need."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Note the ",(0,i.jsx)(n.code,{children:"realm"}),", ",(0,i.jsx)(n.code,{children:"auth-server-url"}),", and ",(0,i.jsx)(n.code,{children:"resource"})," values."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Keycloak OIDC Create Client Adapter Config",src:t(90900).A+"",width:"3000",height:"2081"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["You also need to copy the ",(0,i.jsx)(n.strong,{children:"Client secret"})," in the ",(0,i.jsx)(n.strong,{children:"Credential"})," tab for the client to use. Once on the Credential tab, click the copy button to copy the key to your clipboard. Save the key somewhere for use later in this tutorial"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Keycloak OIDC Create Client Client Secret",src:t(31049).A+"",width:"3492",height:"2212"})}),"\n"]}),"\n"]})]})}function a(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(o,{...e})}):o(e)}},34724:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/deployments-e5cb24a81b832bb19e3adf754c133bf1.png"},35450:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/general-settings-0a3265fecd73272214fb1d3d9c4a57a7.png"},40623:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/login-settings-7706affb95f5f93f7490d7b46f9ec1f4.png"},47475:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/capability-config-with-auth-cdb9c0e4d816fd1b345a2b4f0ad31fea.png"},53213:(e,n,t)=>{t.d(n,{Ay:()=>a,RM:()=>s});var i=t(74848),r=t(28453);const s=[{value:"Install and configure Spring Boot",id:"install-and-configure-spring-boot",level:2},{value:"Testing the secured endpoints",id:"testing-the-secured-endpoints",level:3},{value:"Integration with Angular",id:"integration-with-angular",level:2},{value:"Generate Angular Application",id:"generate-angular-application",level:3},{value:"Securing views",id:"securing-views",level:3},{value:"User Authentication",id:"user-authentication",level:4},{value:"Use Angular guards to secure routes",id:"use-angular-guards-to-secure-routes",level:4}];function o(e){const n={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"install-and-configure-spring-boot",children:"Install and configure Spring Boot"}),"\n",(0,i.jsxs)(n.p,{children:["Now that we've setup and configured Keycloak using ",(0,i.jsx)(n.a,{href:"https://phasetwo.io/dashboard/",children:"Phase Two"})," and cloned or created our Spring Boot application template, we will need to configure the project to leverage the capabilities provided by Keycloak."]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Configure application settings"}),"\n",(0,i.jsxs)(n.p,{children:["Update your ",(0,i.jsx)(n.code,{children:"application.yaml"})," configuration file with the Keycloak security configuration (it's possible your download includes a ",(0,i.jsx)(n.code,{children:"application.properties"})," file instead)."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"spring:\n  application:\n    name: spring-boot-keycloak\n  security:\n    oauth2:\n      resourceserver:\n        jwt:\n          issuer-uri: $http-keycloak-url/auth/realms/$your-realm\n          jwk-set-uri: ${spring.security.oauth2.resourceserver.jwt.issuer-uri}/protocol/openid-connect/certs\n"})}),"\n",(0,i.jsx)(n.p,{children:"Replace"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"$http-keycloak-url"})," with the Keycloak URL from the Phase Two hosted Keycloak instance."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"$your-realm"})," with the Keycloak realm created earlier in this tutorial."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["If you are using the local Keycloak instance from the cloned example, use the local address for ",(0,i.jsx)(n.code,{children:"$http-keycloak-url"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"The below Java code omits any imports, reference our example for necessary imports or use your text editor to assist with populating the imports."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Configure Spring Boot resource server"}),"\n",(0,i.jsxs)(n.p,{children:["Under ",(0,i.jsx)(n.code,{children:"src.main.java.com.springbootkeycloak"})," create a new package, ",(0,i.jsx)(n.code,{children:"config"}),", and create a class ",(0,i.jsx)(n.code,{children:"SecurityConfig.java"}),". In this class, add the ",(0,i.jsx)(n.code,{children:"HttpSecurity"})," settings:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'@Configuration\n@EnableWebSecurity\n@EnableMethodSecurity\npublic class SecurityConfig {\n\n    private final JwtClaimsConverter jwtAuthConverter;\n\n    public SecurityConfig(JwtClaimsConverter jwtAuthConverter) {\n        this.jwtAuthConverter = jwtAuthConverter;\n    }\n\n    @Bean\n    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {\n        http.authorizeHttpRequests(authz ->\n                authz\n                        .requestMatchers("/api/**")\n                        .authenticated()\n        );\n        http.oauth2ResourceServer(oauth2ResourceServer ->\n                oauth2ResourceServer.jwt(jwt -> jwt.jwtAuthenticationConverter(jwtAuthConverter))\n        );\n        http.csrf(AbstractHttpConfigurer::disable);\n\n        http.sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS));\n        return http.build();\n    }\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["This configuration will make the Spring Boot act as an OAuth2 Resource Server's with JWT authentication. This configuration is part of the functionality provided by the ",(0,i.jsx)(n.code,{children:"spring-boot-starter-oauth2-resource-server"})," dependency. Read more about it's configuration ",(0,i.jsx)(n.a,{href:"https://docs.spring.io/spring-security/reference/servlet/oauth2/resource-server/jwt.html#oauth2resourceserver-jwt-sansboot",children:"here"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Add JWT token convert configuration"}),"\n",(0,i.jsxs)(n.p,{children:["In the same ",(0,i.jsx)(n.code,{children:"config"})," package, create another class, ",(0,i.jsx)(n.code,{children:"JwtClaimsConverter.java"}),". Add a converter for extracting the security context attributes from the ",(0,i.jsx)(n.code,{children:"access_token"})," received from Keycloak."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'@Component\npublic class JwtClaimsConverter implements Converter<Jwt, AbstractAuthenticationToken> {\n\n    @Override\n    public AbstractAuthenticationToken convert(Jwt jwt) {\n      var authorities = extractRealmRoles(jwt);\n        return new JwtAuthenticationToken(jwt, authorities, getPrincipalFromClaim(jwt));\n    }\n\n    private String getPrincipalFromClaim(Jwt jwt) {\n        var claimName = "preferred_username";\n        return jwt.getClaim(claimName);\n    }\n\n    private Collection<GrantedAuthority> extractRealmRoles(Jwt jwt) {\n        Map<String, Object> resource = jwt.getClaim("realm_access");\n        Collection<String> roles;\n        if (resource == null\n                || (roles = (Collection<String>) resource.get("roles")) == null) {\n            return Set.of();\n        }\n        return roles.stream()\n                .map(role -> new SimpleGrantedAuthority("ROLE_" + role))\n                .collect(Collectors.toSet());\n    }\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["The provided example uses the ",(0,i.jsx)(n.code,{children:"preferred_username"})," claim for populating the ",(0,i.jsx)(n.em,{children:"principal"})," of the security context and the ",(0,i.jsx)(n.code,{children:"realm_access.roles"})," to populate the ",(0,i.jsx)(n.em,{children:"authorities"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["This configuration is part of the functionality provided by the ",(0,i.jsx)(n.code,{children:"spring-boot-starter-oauth2-resource-server"})," dependency. Read more about it's configuration ",(0,i.jsx)(n.a,{href:"https://docs.spring.io/spring-security/reference/servlet/oauth2/resource-server/jwt.html#oauth2resourceserver-jwt-authorization-extraction",children:"here"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Create the secured API resources:"}),"\n",(0,i.jsxs)(n.p,{children:["In ",(0,i.jsx)(n.code,{children:"src.main.java.com.springbootkeycloak"})," create a new package, ",(0,i.jsx)(n.code,{children:"web"}),", and create a new class ",(0,i.jsx)(n.code,{children:"TestController.java"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"To test the security integration two resource endpoints are defined:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"/api/test/anonymous"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"/api/test/user"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Implemented with this code:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'@RestController\n@RequestMapping("/api/test")\npublic class TestController {\n\n    @RequestMapping(value = "/anonymous", method = RequestMethod.GET)\n    public ResponseEntity<String> getAnonymous() {\n        return ResponseEntity.ok("Hello Anonymous");\n    }\n\n    @PreAuthorize("hasRole(\'ROLE_user\')")\n    @RequestMapping(value = "/user", method = RequestMethod.GET)\n    public ResponseEntity<String> getUser()\n    {\n        return ResponseEntity.ok("Hello Secured with user role.");\n    }\n}\n\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Because both endpoints have the prefix ",(0,i.jsx)(n.code,{children:"/api"})," they will require a secure context in order to access them. Furthermore, the ",(0,i.jsx)(n.code,{children:"/api/test/user"})," endpoint is secured using a predefined authority ",(0,i.jsx)(n.code,{children:"ROLE_user"}),". This is a Realm role that can be created and applied to your example user from earlier in this tutorial."]}),"\n",(0,i.jsx)(n.p,{children:"This logic can be used to extend access and authorization to any part of the application."}),"\n",(0,i.jsxs)(n.p,{children:["Start the application running with ",(0,i.jsx)(n.code,{children:"./gradlew bootRun"}),"."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"testing-the-secured-endpoints",children:"Testing the secured endpoints"}),"\n",(0,i.jsxs)(n.p,{children:["The secured endpoints can be tested using ",(0,i.jsx)(n.code,{children:"curl"})," with the ",(0,i.jsx)(n.code,{children:"Authorization"})," header. The ",(0,i.jsx)(n.code,{children:"Authorization"})," header must contain the ",(0,i.jsx)(n.code,{children:"access_token"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"curl --location 'http://localhost:8080/api/test/anonymous' \\\n    --header 'Authorization: Bearer {{$access_token}}'\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"curl --location 'http://localhost:8080/api/test/user' \\\n    --header 'Authorization: Bearer {{$access_token}}'\n"})}),"\n",(0,i.jsxs)(n.p,{children:["To generate an access token, you can use the ",(0,i.jsx)(n.code,{children:"openid-connect/token"})," endpoint from Keycloak."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"curl -X POST \\\n  --location \"https://$http-keycloak-url/auth/realms/$keycloak-realm/protocol/openid-connect/token\" \\\n  -H 'Content-Type: application/x-www-form-urlencoded' \\\n  -d 'username=$test-user&password=$password&grant_type=password&client_id=$client-name&client_secret=$client-secret'\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Substitute the values from your Keycloak instance and test user for ",(0,i.jsx)(n.code,{children:"$http-keycloak-url"}),", ",(0,i.jsx)(n.code,{children:"$keycloak-realm"}),", ",(0,i.jsx)(n.code,{children:"$test-user"}),", ",(0,i.jsx)(n.code,{children:"$password"}),", ",(0,i.jsx)(n.code,{children:"$client-name"}),", and ",(0,i.jsx)(n.code,{children:"$client-secret"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["In the returned HTTP response, the ",(0,i.jsx)(n.code,{children:"access_token"})," will be present. Use this token to test the secured endpoints in the example curl's above."]}),"\n",(0,i.jsx)(n.p,{children:'At this point, your Spring Boot application is secured with Keycloak, but there is no "Frontend" to the application. In the next section, we will add an Angular SPA to demonstrate sign-in with Keycloak.'}),"\n",(0,i.jsx)(n.h2,{id:"integration-with-angular",children:"Integration with Angular"}),"\n",(0,i.jsx)(n.p,{children:"In order to access the secured resources of the Spring Boot server, we will create a client application which will authenticate our users. After Authentication, that user will then have access to the secured resources via their JWT token."}),"\n",(0,i.jsx)(n.h3,{id:"generate-angular-application",children:"Generate Angular Application"}),"\n",(0,i.jsxs)(n.p,{children:["Our ",(0,i.jsx)(n.a,{href:"https://github.com/p2-inc/examples/tree/main/frameworks/spring-boot-keycloak",children:"Spring Boot example"})," already has a basic Angular application setup. We will use that for the rest of this setup."]}),"\n",(0,i.jsxs)(n.p,{children:["In the example folder, open the ",(0,i.jsx)(n.code,{children:"angularclient"})," folder."]}),"\n",(0,i.jsx)(n.p,{children:"If you do want to start your own Application, follow the instructions below:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Setup a new Angular application following these ",(0,i.jsx)(n.a,{href:"https://angular.io/start",children:"instructions"})]}),"\n",(0,i.jsxs)(n.li,{children:["Use the Angular Oauth2 OIDC ",(0,i.jsx)(n.a,{href:"https://github.com/manfredsteyer/angular-oauth2-oidc",children:"library"})," to integrate authentication and authorization."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"securing-views",children:"Securing views"}),"\n",(0,i.jsxs)(n.p,{children:["In the ",(0,i.jsx)(n.code,{children:"/angularclient/src/app"})," folder, the ",(0,i.jsx)(n.code,{children:"app.module.ts"})," file is the entry point for the Angular application. The Angular application will need to be configured in order to access user information only after authentication."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"@NgModule({\n  declarations: [\n    AppComponent,\n    MainpageComponent\n  ],\n  imports: [\n    BrowserModule,\n    AppRoutingModule,\n    FormsModule,\n    HttpClientModule,\n    OAuthModule.forRoot()\n  ],\n  providers: [\n    {\n      provide: APP_INITIALIZER,\n      useFactory: applicationInitializerFactory,\n      deps: [OAuthService],\n      multi: true\n    },\n    {provide: LOCAL_STORAGE_TOKEN, useFactory: localStorageFactory},\n    {provide: OAuthStorage, useFactory: localStorageFactory}\n  ],\n  bootstrap: [AppComponent]\n})\nexport class AppModule {...}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The app is initialized with the ",(0,i.jsx)(n.code,{children:"OAuthService"})," as a dependency. Tokens from the ",(0,i.jsx)(n.code,{children:"OAuthService"})," are stored in the browser's ",(0,i.jsx)(n.code,{children:"localStorage"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["To configure the ",(0,i.jsx)(n.code,{children:"OAuthService"}),"'s ",(0,i.jsx)(n.code,{children:"authorization code"})," login flow with the ",(0,i.jsx)(n.code,{children:"angular-oauth2-oidc"})," library add the following configuration:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:'function configure() {\n  oauthService.configure({\n    // URL of the SPA to redirect the user to after login\n    redirectUri: window.location.origin + "/index.html",\n    // The SPA\'s id. The SPA is registered with this id at the auth-server\n    clientId: "$your-public-keycloak-client",\n    // set the scope for the permissions the client should request\n    scope: "openid",\n    // url for  /.well-known/openid-configuration endpoint\n    issuer: "http://$http-keycloak-url:8888/auth/realms/$your-keycloak-realm",\n    disablePKCE: true,\n    //initialize the code flow\n    responseType: "code",\n    showDebugInformation: true,\n  });\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Replace ",(0,i.jsx)(n.code,{children:"http-keycloak-url"}),", ",(0,i.jsx)(n.code,{children:"$your-public-keycloak-client"}),", and ",(0,i.jsx)(n.code,{children:"$your-keycloak-realm"})," with your actual Keycloak configurations."]}),"\n",(0,i.jsxs)(n.p,{children:["Start the application with ",(0,i.jsx)(n.code,{children:"npm run start"})]}),"\n",(0,i.jsx)(n.h4,{id:"user-authentication",children:"User Authentication"}),"\n",(0,i.jsxs)(n.p,{children:["In the ",(0,i.jsx)(n.code,{children:"user.component.html"})," file, we authenticate the user to the logged in state and conditionally render the login and logout buttons."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-html",children:'<div *ngIf="isLoggedIn">\n  \x3c!-- Content for logged-in users --\x3e\n  <div class="mb-2 text-p2blue-700 text-2xl">Authenticated</div>\n  <div class="mb-6 text-p2blue-700 text-md">\n    <div *ngIf="userInfo">\n      <p><span class="font-bold">Username</span>: {{ userInfo.username }}</p>\n      <p><span class="font-bold">Email</span>: {{ userInfo.email }}</p>\n      <p><span class="font-bold">Roles</span>: {{ userInfo.roles }}</p>\n    </div>\n  </div>\n  <button [class]="buttonClasses" (click)="signOut()">Sign Out</button>\n</div>\n<div *ngIf="!isLoggedIn">\n  <div class="mb-6 text-p2blue-700 text-2xl">Not authenticated.</div>\n  <button [class]="buttonClasses" (click)="signIn()">Sign In</button>\n</div>\n'})}),"\n",(0,i.jsxs)(n.p,{children:["the ",(0,i.jsx)(n.code,{children:"isLoggedIn"})," function can be found in the ",(0,i.jsx)(n.code,{children:"user.component.ts"})," file."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"this.isLoggedIn = this.oauthService.hasValidAccessToken();\n"})}),"\n",(0,i.jsx)(n.p,{children:"Clicking the Log In or Log Out buttons will redirect to the Keycloak login page or log the user out."}),"\n",(0,i.jsx)(n.h4,{id:"use-angular-guards-to-secure-routes",children:"Use Angular guards to secure routes"}),"\n",(0,i.jsx)(n.p,{children:"We can achieve route restriction by using guards. If the access token is not valid the guard will initiate the login flow. You could optionally apply this at the router level to enforce a full page login."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"export class AuthGuard implements CanActivate {\n\n  constructor(private oauthService: OAuthService) {\n  }\n\n  canActivate(route: ActivatedRouteSnapshot, state: RouterStateSnapshot): Observable<boolean | UrlTree>{\n    if(!this.oauthService.hasValidAccessToken()) {\n      this.oauthService.initLoginFlow();\n    }\n    return of(true);\n  }\n}\n"})})]})}function a(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(o,{...e})}):o(e)}},57117:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/email_link-cefd0e50772e855bbaa5de46bda7f504.png"},70643:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>d,frontMatter:()=>o,metadata:()=>i,toc:()=>l});var i=t(28993),r=t(74848),s=t(28453);t(71051),t(32991),t(83201),t(53213);const o={slug:"secure-spring-boot",title:"Securing an Angular and Spring Boot Application with Keycloak",description:"Learn how to secure resources and access of an Angular and Spring Boot application using Keycloak for Authentication and Authorizationusing the open source IAMs Keycloak for Authentication and Authorization",authors:"phasetwo",tags:["phase_two","tutorial","frameworks","spring_boot","authentication","authorization","sso"],image:"/blog/og/springboot@2x.png"},a=void 0,c={authorsImageUrls:[void 0]},l=[];function h(e){const n={a:"a",p:"p",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://spring.io/projects/spring-boot",children:"Spring Boot"})," is a open-source tool which uses Java-based frameworks for building web applications."]}),"\n",(0,r.jsxs)(n.p,{children:["In this article we'll be using ",(0,r.jsx)(n.a,{href:"https://www.keycloak.org/",children:"Keycloak"})," to secure an ",(0,r.jsx)(n.a,{href:"https://angular.io/",children:"Angular"})," application and access secured resources from a Spring Boot Web application."]})]})}function d(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},71051:(e,n,t)=>{t.d(n,{Ay:()=>a,RM:()=>s});var i=t(74848),r=t(28453);const s=[];function o(e){const n={a:"a",admonition:"admonition",img:"img",li:"li",p:"p",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsx)(n.p,{children:"If you already have a functioning Keycloak instance, you can skip to the next section."})}),"\n",(0,i.jsxs)(n.p,{children:['Rather than trying to set up a "from scratch" instance of Keycloak, we\'re going to short-circuit that process by leveraging a free ',(0,i.jsx)(n.a,{href:"https://phasetwo.io/",children:"Phase Two Starter"})," instance. The Starter provides a free hosted instance of Phase Two's enhanced Keycloak ready for light production use cases."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Visit the sign-up ",(0,i.jsx)(n.a,{href:"https://phasetwo.io/dashboard/",children:"page"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Enter an email, use a Github account, or use an existing Google account to register."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Phase Two Register",src:t(90865).A+"",width:"3000",height:"1763"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Follow the register steps. This will include a sign-in link being sent to your email. Use that for password-less login."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Phase Two Email Magic Link Register",src:t(57117).A+"",width:"3000",height:"857"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["After creating an account, a ",(0,i.jsx)(n.a,{href:"https://www.youtube.com/watch?v=ZTFlc-3pG1M",children:"realm"})," is automatically created for you with all of the Phase Two enhancements. You need to create a Deployment in the Shared Phase Two infrastructure in order to gain access to the realm. Without a deployment created, the Create Shared Deployment modal will automatically pop up."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:'Create a Shared Deployment by providing a region (pick something close to your existing infrastructure), a name for the deployment, and selecting the default organization that was created for you upon account creation. Hit "Confirm" when ready. Standby while our robots get to work generating your deployment. This can take a few seconds.'}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Phase Two Create Shared Deployment",src:t(12776).A+"",width:"3000",height:"1541"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:'After the deployment is created and active, you can access the Keycloak Admin console by clicking "Open Console" for that deployment. Open it now to see the console.'}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Phase Two Open Console Keycloak Admin UI",src:t(34724).A+"",width:"3000",height:"1311"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"At this point, move on to the next step in the tutorial. We'll be coming back to the Admin Console when its time to start connecting our App to the Keycloak instance."})]})}function a(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(o,{...e})}):o(e)}},83201:(e,n,t)=>{t.d(n,{Ay:()=>a,RM:()=>s});var i=t(74848),r=t(28453);const s=[];function o(e){const n={admonition:"admonition",li:"li",ol:"ol",p:"p",strong:"strong",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsx)(n.p,{children:"It is bad practice to use your Admin user to sign in to an Application."})}),"\n",(0,i.jsx)(n.p,{children:"Since we do not want to use our Admin user for signing into the app we will build, we need to add a another non-admin user."}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Open the Admin UI by clicking ",(0,i.jsx)(n.strong,{children:"Open Console"})," in the Phase Two Dashboard."]}),"\n",(0,i.jsxs)(n.li,{children:["Click ",(0,i.jsx)(n.strong,{children:"Users"})," in the menu."]}),"\n",(0,i.jsxs)(n.li,{children:["Click ",(0,i.jsx)(n.strong,{children:"Add user"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Fill out the information for Email, First name, and Last name. Click ",(0,i.jsx)(n.strong,{children:"Create"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["We will now set the password for this user manually. Click ",(0,i.jsx)(n.strong,{children:"Credentials"})," (tab) and click ",(0,i.jsx)(n.strong,{children:"Set Password"}),'. Provide a password for this user. For our use case, as a tutorial, you can leave "Temporary" set to "Off".']}),"\n",(0,i.jsxs)(n.li,{children:["Click ",(0,i.jsx)(n.strong,{children:"Save"})," and confirm the password by clicking ",(0,i.jsx)(n.strong,{children:"Save password"})]}),"\n"]})]})}function a(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(o,{...e})}):o(e)}},90865:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/register-c45850867ce85096a398bb0dfab9df4d.png"},90900:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/adapter-config-c561561514672a51754146ff56e6bbe3.png"}}]);