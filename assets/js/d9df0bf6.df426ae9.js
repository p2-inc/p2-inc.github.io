"use strict";(self.webpackChunkphasetwo_docs=self.webpackChunkphasetwo_docs||[]).push([[9566],{83201:(e,n,t)=>{t.d(n,{Ay:()=>r,RM:()=>a});var i=t(74848),o=t(28453);const a=[];function s(e){const n={admonition:"admonition",li:"li",ol:"ol",p:"p",strong:"strong",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsx)(n.p,{children:"It is bad practice to use your Admin user to sign in to an Application."})}),"\n",(0,i.jsx)(n.p,{children:"Since we do not want to use our Admin user for signing into the app we will build, we need to add a another non-admin user."}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Open the Admin UI by clicking ",(0,i.jsx)(n.strong,{children:"Open Console"})," in the Phase Two Dashboard."]}),"\n",(0,i.jsxs)(n.li,{children:["Click ",(0,i.jsx)(n.strong,{children:"Users"})," in the menu."]}),"\n",(0,i.jsxs)(n.li,{children:["Click ",(0,i.jsx)(n.strong,{children:"Add user"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Fill out the information for Email, First name, and Last name. Click ",(0,i.jsx)(n.strong,{children:"Create"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["We will now set the password for this user manually. Click ",(0,i.jsx)(n.strong,{children:"Credentials"})," (tab) and click ",(0,i.jsx)(n.strong,{children:"Set Password"}),'. Provide a password for this user. For our use case, as a tutorial, you can leave "Temporary" set to "Off".']}),"\n",(0,i.jsxs)(n.li,{children:["Click ",(0,i.jsx)(n.strong,{children:"Save"})," and confirm the password by clicking ",(0,i.jsx)(n.strong,{children:"Save password"})]}),"\n"]})]})}function r(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(s,{...e})}):s(e)}},32991:(e,n,t)=>{t.d(n,{Ay:()=>r,RM:()=>a});var i=t(74848),o=t(28453);const a=[{value:"OIDC Config",id:"oidc-config",level:3}];function s(e){const n={a:"a",code:"code",em:"em",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components},{Details:a}=n;return a||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.p,{children:["We need to create a ",(0,i.jsx)(n.a,{href:"https://www.keycloak.org/docs/latest/server_admin/#con-oidc_server_administration_guide",children:"OpenID Connect"})," Client in Keycloak for the app to communicate with. Keycloak's ",(0,i.jsx)(n.a,{href:"https://www.keycloak.org/docs/latest/server_admin/#_oidc_clients",children:"docs"})," provide steps for how to create an OIDC client and all the various configurations that can be introduced. Follow the steps below to create a client and get the right information necessary for app configuration."]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Open the Admin UI by clicking ",(0,i.jsx)(n.strong,{children:"Open Console"})," in the Phase Two Dashboard."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Click ",(0,i.jsx)(n.strong,{children:"Clients"})," in the menu."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Click ",(0,i.jsx)(n.strong,{children:"Create client"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Leave ",(0,i.jsx)(n.strong,{children:"Client type"})," set to ",(0,i.jsx)(n.strong,{children:"OpenID Connect"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Enter a ",(0,i.jsx)(n.strong,{children:"Client ID"}),". This ID is an alphanumeric string that is used in OIDC requests and in the Keycloak database to identify the client."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Supply a ",(0,i.jsx)(n.strong,{children:"Name"})," for the client."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Click ",(0,i.jsx)(n.strong,{children:"Next"}),"."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Keycloak OIDC Create Client General Settings",src:t(35450).A+"",width:"3000",height:"2072"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Under the Capability Config section, leave the defaults as selected. This can be configured further later."}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Client authentication to On."}),"\n",(0,i.jsx)(n.li,{children:"Authorization to Off."}),"\n",(0,i.jsx)(n.li,{children:"Standard flow checked. Direct access grants checked. All other items unchecked."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Keycloak OIDC Create Client Capability Config with Authentication",src:t(47475).A+"",width:"3000",height:"1909"})}),"\n",(0,i.jsxs)(n.p,{children:["Click ",(0,i.jsx)(n.strong,{children:"Next"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Under Login settings we need to add a redirect URI and Web origin in order. Assuming you are using the example applicaiton:"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.em,{children:"Valid redirect URI"})," (allows redirect back to application)"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"http://localhost:3000/*\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.em,{children:"Web origins"})," (allows for Token auth call)"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"http://localhost:3000\n"})}),"\n",(0,i.jsxs)(a,{children:[(0,i.jsx)("summary",{children:"URI and Origin Details"}),(0,i.jsxs)(n.p,{children:["The choice of ",(0,i.jsx)(n.code,{children:"localhost"})," is arbitrary. If you are using an example application running locally, this will apply. If you are using an app that you actually have deployed somewhere, then you will need to substitute the appropriate URI for that."]})]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Click ",(0,i.jsx)(n.strong,{children:"Save"})]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Keycloak OIDC Create Login Settings",src:t(40623).A+"",width:"3000",height:"2074"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"oidc-config",children:"OIDC Config"}),"\n",(0,i.jsx)(n.p,{children:"We will need values to configure our application. To get these values follow the instructions below."}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Click ",(0,i.jsx)(n.strong,{children:"Clients"})," in the menu."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Find the Client you just created and click on it. In the top right click the ",(0,i.jsx)(n.strong,{children:"Action"})," dropdown and select ",(0,i.jsx)(n.strong,{children:"Download adapter config"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Select ",(0,i.jsx)(n.strong,{children:"Keycloak OIDC JSON"})," in the format option. The details section will populate with the details we will need."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Note the ",(0,i.jsx)(n.code,{children:"realm"}),", ",(0,i.jsx)(n.code,{children:"auth-server-url"}),", and ",(0,i.jsx)(n.code,{children:"resource"})," values."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Keycloak OIDC Create Client Adapter Config",src:t(90900).A+"",width:"3000",height:"2081"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["You also need to copy the ",(0,i.jsx)(n.strong,{children:"Client secret"})," in the ",(0,i.jsx)(n.strong,{children:"Credential"})," tab for the client to use. Once on the Credential tab, click the copy button to copy the key to your clipboard. Save the key somewhere for use later in this tutorial"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Keycloak OIDC Create Client Client Secret",src:t(31049).A+"",width:"3492",height:"2212"})}),"\n"]}),"\n"]})]})}function r(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(s,{...e})}):s(e)}},71051:(e,n,t)=>{t.d(n,{Ay:()=>r,RM:()=>a});var i=t(74848),o=t(28453);const a=[];function s(e){const n={a:"a",admonition:"admonition",img:"img",li:"li",p:"p",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsx)(n.p,{children:"If you already have a functioning Keycloak instance, you can skip to the next section."})}),"\n",(0,i.jsxs)(n.p,{children:['Rather than trying to set up a "from scratch" instance of Keycloak, we\'re going to short-circuit that process by leveraging a free ',(0,i.jsx)(n.a,{href:"https://phasetwo.io/",children:"Phase Two Starter"})," instance. The Starter provides a free hosted instance of Phase Two's enhanced Keycloak ready for light production use cases."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Visit the sign-up ",(0,i.jsx)(n.a,{href:"https://phasetwo.io/dashboard/",children:"page"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Enter an email, use a Github account, or use an existing Google account to register."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Phase Two Register",src:t(90865).A+"",width:"3000",height:"1763"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Follow the register steps. This will include a sign-in link being sent to your email. Use that for password-less login."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Phase Two Email Magic Link Register",src:t(57117).A+"",width:"3000",height:"857"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["After creating an account, a ",(0,i.jsx)(n.a,{href:"https://www.youtube.com/watch?v=ZTFlc-3pG1M",children:"realm"})," is automatically created for you with all of the Phase Two enhancements. You need to create a Deployment in the Shared Phase Two infrastructure in order to gain access to the realm. Without a deployment created, the Create Shared Deployment modal will automatically pop up."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:'Create a Shared Deployment by providing a region (pick something close to your existing infrastructure), a name for the deployment, and selecting the default organization that was created for you upon account creation. Hit "Confirm" when ready. Standby while our robots get to work generating your deployment. This can take a few seconds.'}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Phase Two Create Shared Deployment",src:t(12776).A+"",width:"3000",height:"1541"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:'After the deployment is created and active, you can access the Keycloak Admin console by clicking "Open Console" for that deployment. Open it now to see the console.'}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Phase Two Open Console Keycloak Admin UI",src:t(34724).A+"",width:"3000",height:"1311"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"At this point, move on to the next step in the tutorial. We'll be coming back to the Admin Console when its time to start connecting our App to the Keycloak instance."})]})}function r(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(s,{...e})}):s(e)}},52391:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>h,contentTitle:()=>d,default:()=>g,frontMatter:()=>c,metadata:()=>i,toc:()=>u});var i=t(79911),o=t(74848),a=t(28453),s=t(71051),r=t(32991),l=t(83201);const c={slug:"secure-django",title:"Django Web Authentication with Keycloak",description:"Learn how to quickly secure a Django application with user management and SSO using the open source IAMs Keycloak for Authentication and Authorization",authors:"phasetwo",tags:["phase_two","tutorial","frameworks","django","authentication","authorization","sso"]},d=void 0,h={authorsImageUrls:[void 0]},u=[{value:"Setting up a Django Project",id:"setting-up-a-django-project",level:2},{value:"Quick Start",id:"quick-start",level:3},{value:"Setting up a Keycloak Instance",id:"setting-up-a-keycloak-instance",level:2},...s.RM,{value:"Setting up an OIDC Client",id:"setting-up-an-oidc-client",level:2},...r.RM,{value:"Adding a Non-Admin User",id:"adding-a-non-admin-user",level:2},...l.RM,{value:"Install and configure the Django OIDC library",id:"install-and-configure-the-django-oidc-library",level:2},{value:"Using it in your app",id:"using-it-in-your-app",level:2},{value:"Protect your views",id:"protect-your-views",level:3},{value:"Accessing user information",id:"accessing-user-information",level:3},{value:"Use Username rather than Email",id:"use-username-rather-than-email",level:4},{value:"Logging out",id:"logging-out",level:3},{value:"Add support for Django Rest Framework",id:"add-support-for-django-rest-framework",level:2},{value:"Learning more",id:"learning-more",level:2}];function p(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,a.R)(),...e.components},{Details:t}=n;return t||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.a,{href:"https://www.djangoproject.com/",children:"Django"})," is a high-level, open-source web framework for building web applications using the Python programming language. It follows the Model-View-Controller (MVC) architectural pattern."]}),"\n",(0,o.jsxs)(n.p,{children:["In this article we'll be using ",(0,o.jsx)(n.a,{href:"https://www.keycloak.org/",children:"Keycloak"})," to secure a Django Web application."]}),"\n",(0,o.jsx)(n.admonition,{type:"info",children:(0,o.jsxs)(n.p,{children:["If you just want to skip to the code, visit the Phase Two ",(0,o.jsx)(n.a,{href:"https://github.com/p2-inc/examples/tree/main/frameworks/django",children:"Django example"}),". We are also building ",(0,o.jsx)(n.a,{href:"https://github.com/p2-inc/examples",children:"Keycloak examples"})," for other frameworks."]})}),"\n",(0,o.jsx)(n.h2,{id:"setting-up-a-django-project",children:"Setting up a Django Project"}),"\n",(0,o.jsxs)(n.p,{children:["The following could be applied to an existing Django application, but we have chosen to use the excellent tutorial application built by ",(0,o.jsx)(n.a,{href:"https://developer.mozilla.org/en-US/docs/Learn/Server-side/Django",children:"Mozilla"})," as our example. If you aren't yet familiar with Django, we encourage you to follow the tutorial there."]}),"\n",(0,o.jsx)(n.p,{children:"The completed code for that tutorial is available in their GitHub repository. We'll clone it to get started."}),"\n",(0,o.jsx)(n.h3,{id:"quick-start",children:"Quick Start"}),"\n",(0,o.jsx)(n.p,{children:"To get this project up and running locally on your computer:"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["Set up the ",(0,o.jsx)(n.a,{href:"https://developer.mozilla.org/en-US/docs/Learn/Server-side/Django/development_environment",children:"Python development environment"}),".\nWe recommend using a Python virtual environment."]}),"\n",(0,o.jsxs)(n.li,{children:["Assuming you have Python setup, run the following commands (if you're on Windows you may use ",(0,o.jsx)(n.code,{children:"py"})," or ",(0,o.jsx)(n.code,{children:"py -3"})," instead of ",(0,o.jsx)(n.code,{children:"python"})," to start Python):","\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"pip install -r requirements.txt\npython manage.py makemigrations\npython manage.py migrate\npython manage.py collectstatic\npython manage.py test # Run the standard tests. These should all pass.\npython manage.py createsuperuser # Create a superuser\npython manage.py runserver\n"})}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["Open a browser to ",(0,o.jsx)(n.code,{children:"http://127.0.0.1:8000/admin/"})," to open the admin site"]}),"\n",(0,o.jsx)(n.li,{children:"Create a few test objects of each type."}),"\n",(0,o.jsxs)(n.li,{children:["Open tab to ",(0,o.jsx)(n.code,{children:"http://127.0.0.1:8000"})," to see the main site, with your new objects."]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"setting-up-a-keycloak-instance",children:"Setting up a Keycloak Instance"}),"\n",(0,o.jsx)(n.p,{children:"Before customizing the Django app, we need to set up and configure our Keycloak instance."}),"\n",(0,o.jsxs)(t,{children:[(0,o.jsx)("summary",{children:"Instructions"}),(0,o.jsx)(s.Ay,{})]}),"\n",(0,o.jsx)(n.h2,{id:"setting-up-an-oidc-client",children:"Setting up an OIDC Client"}),"\n",(0,o.jsxs)(t,{children:[(0,o.jsx)("summary",{children:"Instructions"}),(0,o.jsx)(r.Ay,{})]}),"\n",(0,o.jsx)(n.h2,{id:"adding-a-non-admin-user",children:"Adding a Non-Admin User"}),"\n",(0,o.jsxs)(t,{children:[(0,o.jsx)("summary",{children:"Instructions"}),(0,o.jsx)(l.Ay,{})]}),"\n",(0,o.jsx)(n.h2,{id:"install-and-configure-the-django-oidc-library",children:"Install and configure the Django OIDC library"}),"\n",(0,o.jsx)(n.p,{children:"Now that we've installed and configured Keycloak, we need to setup Django to replace the native authentication method provided by the framework. The first task is to install a library that is compatible with Keycloak's OIDC implementation."}),"\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.a,{href:"https://mozilla-django-oidc.readthedocs.io/",children:"mozilla-django-oidc"})," library provides an easy way to integrate Keycloak (or any OpenID Connect-compliant identity provider) with your Django app. It abstracts many of the complexities of integrating authentication and authorization. Here's how you can set it up:"]}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Install the Package"}),":\nInstall the ",(0,o.jsx)(n.code,{children:"mozilla-django-oidc"})," package using pip:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"pip install mozilla-django-oidc\n"})}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Configure Django Settings"}),":\nUpdate your Django app's ",(0,o.jsx)(n.code,{children:"settings.py"})," to include the necessary configurations for ",(0,o.jsx)(n.code,{children:"mozilla-django-oidc"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:"INSTALLED_APPS = [\n    # ...\n    'django.contrib.auth',\n    'mozilla_django_oidc',  # Load after django.contrib.auth\n    # ...\n]\n\nAUTHENTICATION_BACKENDS = (\n    'mozilla_django_oidc.auth.OIDCAuthenticationBackend',\n    # ...\n)\n\nOIDC_RP_CLIENT_ID = 'your-client-id'\nOIDC_RP_CLIENT_SECRET = 'your-client-secret'\nOIDC_OP_AUTHORIZATION_ENDPOINT = 'https://keycloak-url/auth/realms/your-realm/protocol/openid-connect/auth'\nOIDC_OP_TOKEN_ENDPOINT = 'https://keycloak-url/auth/realms/your-realm/protocol/openid-connect/token'\nOIDC_OP_USER_ENDPOINT = 'https://keycloak-url/auth/realms/your-realm/protocol/openid-connect/userinfo'\nOIDC_OP_JWKS_ENDPOINT = 'https://keycloak-url/auth/realms/your-realm/protocol/openid-connect/certs'\nOIDC_RP_SIGN_ALGO = 'RS256'\n\nLOGIN_URL = 'oidc_authentication_init'\nLOGOUT_REDIRECT_URL = '/'\nLOGIN_REDIRECT_URL = '/'\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Replace ",(0,o.jsx)(n.code,{children:"your-client-id"}),", ",(0,o.jsx)(n.code,{children:"your-client-secret"}),", and the Keycloak URLs with your actual Keycloak configurations."]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Add URLs"}),":\nUpdate your Django app's ",(0,o.jsx)(n.code,{children:"urls.py"})," to include the authentication URLs provided by ",(0,o.jsx)(n.code,{children:"mozilla-django-oidc"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:"urlpatterns += [\n    path('oidc/', include('mozilla_django_oidc.urls')),\n]\n"})}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"using-it-in-your-app",children:"Using it in your app"}),"\n",(0,o.jsx)(n.h3,{id:"protect-your-views",children:"Protect your views"}),"\n",(0,o.jsxs)(n.p,{children:["Use Decorators for Access Control. You can now use the ",(0,o.jsx)(n.code,{children:"@oidc_protected"})," decorator to protect views that require authentication and potentially specific roles:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:"from mozilla_django_oidc.decorators import oidc_protected\n\n@oidc_protected\ndef protected_view(request):\n    # Your view logic\n"})}),"\n",(0,o.jsx)(n.h3,{id:"accessing-user-information",children:"Accessing user information"}),"\n",(0,o.jsxs)(n.p,{children:["You can access user information after authentication using the ",(0,o.jsx)(n.code,{children:"request.oidc_user"})," attribute. For example:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:"def profile_view(request):\n    user_info = request.oidc_user.userinfo\n    # Access user_info['sub'], user_info['email'], etc.\n    # Your view logic\n"})}),"\n",(0,o.jsxs)(n.p,{children:["By default, ",(0,o.jsx)(n.code,{children:"mozilla-django-oidc"})," looks up a Django user matching the email field to the email address returned in the user info data from Keycloak."]}),"\n",(0,o.jsxs)(n.p,{children:["If a user logs into your site and doesn\u2019t already have an account, by default, ",(0,o.jsx)(n.code,{children:"mozilla-django-oidc"})," will create a new Django user account. It will create the User instance filling in the username (hash of the email address) and email fields."]}),"\n",(0,o.jsx)(n.h4,{id:"use-username-rather-than-email",children:"Use Username rather than Email"}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"mozilla-django-oidc"})," defaults to setting up Django users using the email address as the user name from keycloak was required. Fortunately, ",(0,o.jsx)(n.code,{children:"preferred_username"})," is set up by default in Keycloak as a claim. The claim can used by overriding the ",(0,o.jsx)(n.code,{children:"OIDCAuthenticationBackend"})," class in ",(0,o.jsx)(n.code,{children:"mozilla_django_oidc.auth"})," and referring to this in ",(0,o.jsx)(n.code,{children:"AUTHENTICATION_BACKENDS"})," as below:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:"\n# Classes to override default OIDCAuthenticationBackend (Keycloak authentication)\nfrom mozilla_django_oidc.auth import OIDCAuthenticationBackend\n\nclass KeycloakOIDCAuthenticationBackend(OIDCAuthenticationBackend):\n\n def create_user(self, claims):\n     \"\"\" Overrides Authentication Backend so that Django users are\n         created with the keycloak preferred_username.\n         If nothing found matching the email, then try the username.\n     \"\"\"\n     user = super(KeycloakOIDCAuthenticationBackend, self).create_user(claims)\n     user.first_name = claims.get('given_name', '')\n     user.last_name = claims.get('family_name', '')\n     user.email = claims.get('email')\n     user.username = claims.get('preferred_username')\n     user.save()\n     return user\n\n def filter_users_by_claims(self, claims):\n     \"\"\" Return all users matching the specified email.\n         If nothing found matching the email, then try the username\n     \"\"\"\n     email = claims.get('email')\n     preferred_username = claims.get('preferred_username')\n\n     if not email:\n         return self.UserModel.objects.none()\n     users = self.UserModel.objects.filter(email__iexact=email)\n\n     if len(users) < 1:\n         if not preferred_username:\n             return self.UserModel.objects.none()\n         users = self.UserModel.objects.filter(username__iexact=preferred_username)\n     return users\n\n def update_user(self, user, claims):\n     user.first_name = claims.get('given_name', '')\n     user.last_name = claims.get('family_name', '')\n     user.email = claims.get('email')\n     user.username = claims.get('preferred_username')\n     user.save()\n     return user\n"})}),"\n",(0,o.jsx)(n.p,{children:"In settings.py, overide the new library you have just added in AUTHENTICATION_BACKENDS :"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:' # mozilla_django_oidc - Keycloak authentication\n "fragalysis.auth.KeycloakOIDCAuthenticationBackend",\n'})}),"\n",(0,o.jsx)(n.h3,{id:"logging-out",children:"Logging out"}),"\n",(0,o.jsxs)(n.p,{children:["You can use the ",(0,o.jsx)(n.code,{children:"@oidc_logout"})," decorator to log the user out of both your app and Keycloak:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:"from mozilla_django_oidc.decorators import oidc_logout\n\n@oidc_logout\ndef logout_view(request):\n    # Your logout view logic\n"})}),"\n",(0,o.jsx)(n.h2,{id:"add-support-for-django-rest-framework",children:"Add support for Django Rest Framework"}),"\n",(0,o.jsx)(n.p,{children:"Django Rest Framework (DRF) is a flexible toolkit built on top of Django, specifically designed for building RESTful APIs."}),"\n",(0,o.jsx)(n.p,{children:"If you want DRF to authenticate users based on an OAuth access token provided in the Authorization header, you can use the DRF-specific authentication class which ships with the package."}),"\n",(0,o.jsx)(n.p,{children:"Add this to your settings:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:"REST_FRAMEWORK = {\n    'DEFAULT_AUTHENTICATION_CLASSES': [\n        'mozilla_django_oidc.contrib.drf.OIDCAuthentication',\n        'rest_framework.authentication.SessionAuthentication',\n        # other authentication classes, if needed\n    ],\n}\n"})}),"\n",(0,o.jsx)(n.p,{children:"Note that this only takes care of authenticating against an access token, and provides no options to create or renew tokens."}),"\n",(0,o.jsx)(n.p,{children:"If you\u2019ve created a custom Django OIDCAuthenticationBackend and added that to your AUTHENTICATION_BACKENDS, the DRF class should be smart enough to figure that out. Alternatively, you can manually set the OIDC backend to use:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:"OIDC_DRF_AUTH_BACKEND = 'mozilla_django_oidc.auth.OIDCAuthenticationBackend'\n"})}),"\n",(0,o.jsx)(n.h2,{id:"learning-more",children:"Learning more"}),"\n",(0,o.jsxs)(n.p,{children:["Phase Two's enhanced Keycloak provides many ways to quickly control and tweak the log in and user management experience. Our ",(0,o.jsx)(n.a,{href:"https://phasetwo.io/blog",children:"blog"})," has many use cases from ",(0,o.jsx)(n.a,{href:"https://phasetwo.io/blog/customizing-login-pages",children:"customizing login pages"}),", setting up ",(0,o.jsx)(n.a,{href:"https://phasetwo.io/blog/set-up-magic-links",children:"magic links"})," (passwordless sign in), and ",(0,o.jsx)(n.a,{href:"https://phasetwo.io/product/organizations",children:"Organization"})," workflows."]})]})}function g(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(p,{...e})}):p(e)}},90900:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/adapter-config-c561561514672a51754146ff56e6bbe3.png"},47475:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/capability-config-with-auth-cdb9c0e4d816fd1b345a2b4f0ad31fea.png"},31049:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/copy-credential-c9822fe7c52d15c588ca6661aa2416fd.png"},35450:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/general-settings-0a3265fecd73272214fb1d3d9c4a57a7.png"},40623:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/login-settings-7706affb95f5f93f7490d7b46f9ec1f4.png"},12776:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/create_shared_deployment-a4fc0584f6318f037cf191e06c9703b8.png"},34724:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/deployments-e5cb24a81b832bb19e3adf754c133bf1.png"},57117:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/email_link-cefd0e50772e855bbaa5de46bda7f504.png"},90865:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/register-c45850867ce85096a398bb0dfab9df4d.png"},28453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>r});var i=t(96540);const o={},a=i.createContext(o);function s(e){const n=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),i.createElement(a.Provider,{value:n},e.children)}},79911:e=>{e.exports=JSON.parse('{"permalink":"/blog/secure-django","source":"@site/blog/2023-08-31-secure-django.mdx","title":"Django Web Authentication with Keycloak","description":"Learn how to quickly secure a Django application with user management and SSO using the open source IAMs Keycloak for Authentication and Authorization","date":"2023-08-31T00:00:00.000Z","tags":[{"inline":true,"label":"phase_two","permalink":"/blog/tags/phase-two"},{"inline":true,"label":"tutorial","permalink":"/blog/tags/tutorial"},{"inline":true,"label":"frameworks","permalink":"/blog/tags/frameworks"},{"inline":true,"label":"django","permalink":"/blog/tags/django"},{"inline":true,"label":"authentication","permalink":"/blog/tags/authentication"},{"inline":true,"label":"authorization","permalink":"/blog/tags/authorization"},{"inline":true,"label":"sso","permalink":"/blog/tags/sso"}],"readingTime":5.43,"hasTruncateMarker":true,"authors":[{"name":"Phase Two","title":"Hosted Keycloak and Keycloak Support","url":"https://github.com/p2-inc","email":"support@phasetwo.io","imageURL":"https://avatars.githubusercontent.com/u/60152109?s=200&v=4","key":"phasetwo","page":null}],"frontMatter":{"slug":"secure-django","title":"Django Web Authentication with Keycloak","description":"Learn how to quickly secure a Django application with user management and SSO using the open source IAMs Keycloak for Authentication and Authorization","authors":"phasetwo","tags":["phase_two","tutorial","frameworks","django","authentication","authorization","sso"]},"unlisted":false,"prevItem":{"title":"Securing Nuxt Apps with Keycloak","permalink":"/blog/instant-user-managemenet-and-sso-for-nuxt"},"nextItem":{"title":"Securing Next.js Apps with Keycloak","permalink":"/blog/instant-user-managemenet-and-sso-for-nextjs"}}')}}]);