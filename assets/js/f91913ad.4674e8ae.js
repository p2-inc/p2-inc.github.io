"use strict";(self.webpackChunkphasetwo_docs=self.webpackChunkphasetwo_docs||[]).push([[6098],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return m}});var a=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=a.createContext({}),u=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=u(e.components);return a.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),d=u(n),m=o,h=d["".concat(s,".").concat(m)]||d[m]||p[m]||r;return n?a.createElement(h,i(i({ref:t},c),{},{components:n})):a.createElement(h,i({ref:t},c))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:o,i[1]=l;for(var u=2;u<r;u++)i[u]=n[u];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},50014:function(e,t,n){n.r(t),n.d(t,{assets:function(){return s},contentTitle:function(){return i},default:function(){return p},frontMatter:function(){return r},metadata:function(){return l},toc:function(){return u}});var a=n(83117),o=(n(67294),n(3905));const r={id:"django",title:"Django"},i=void 0,l={unversionedId:"securing-applications/django",id:"securing-applications/django",title:"Django",description:"The following could be applied to an existing Django application, but we have chosen to use the excellent tutorial application built by Mozilla as our example. If you aren't yet familiar with Django, we encourage you to follow the tutorial there.",source:"@site/docs/securing-applications/django.md",sourceDirName:"securing-applications",slug:"/securing-applications/django",permalink:"/docs/securing-applications/django",draft:!1,editUrl:"https://github.com/p2-inc/phasetwo-docs/tree/main/docs/securing-applications/django.md",tags:[],version:"current",frontMatter:{id:"django",title:"Django"},sidebar:"docs",previous:{title:"Nuxt",permalink:"/docs/securing-applications/nuxt"},next:{title:"API",permalink:"/docs/api/"}},s={},u=[{value:"Quick Start",id:"quick-start",level:2},{value:"Install and configure the Django OIDC library",id:"install-and-configure-the-django-oidc-library",level:2},{value:"Using it in your app",id:"using-it-in-your-app",level:2},{value:"Protect your views",id:"protect-your-views",level:3},{value:"Accessing user information",id:"accessing-user-information",level:3},{value:"Use Username rather than Email",id:"use-username-rather-than-email",level:4},{value:"Logging out",id:"logging-out",level:3},{value:"Add support for Django Rest Framework",id:"add-support-for-django-rest-framework",level:2}],c={toc:u};function p(e){let{components:t,...n}=e;return(0,o.kt)("wrapper",(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"The following could be applied to an existing Django application, but we have chosen to use the excellent tutorial application built by ",(0,o.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Learn/Server-side/Django"},"Mozilla")," as our example. If you aren't yet familiar with Django, we encourage you to follow the tutorial there."),(0,o.kt)("p",null,"The completed code for that tutorial is available in their GitHub repository. We'll clone it to get started."),(0,o.kt)("p",null,"A full ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/p2-inc/examples/tree/main/frameworks/django"},"Django example")," is available."),(0,o.kt)("h2",{id:"quick-start"},"Quick Start"),(0,o.kt)("p",null,"To get this project up and running locally on your computer:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Set up the ",(0,o.kt)("a",{parentName:"li",href:"https://developer.mozilla.org/en-US/docs/Learn/Server-side/Django/development_environment"},"Python development environment"),".\nWe recommend using a Python virtual environment."),(0,o.kt)("li",{parentName:"ol"},"Assuming you have Python setup, run the following commands (if you're on Windows you may use ",(0,o.kt)("inlineCode",{parentName:"li"},"py")," or ",(0,o.kt)("inlineCode",{parentName:"li"},"py -3")," instead of ",(0,o.kt)("inlineCode",{parentName:"li"},"python")," to start Python):",(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre"},"pip install -r requirements.txt\npython manage.py makemigrations\npython manage.py migrate\npython manage.py collectstatic\npython manage.py test # Run the standard tests. These should all pass.\npython manage.py createsuperuser # Create a superuser\npython manage.py runserver\n"))),(0,o.kt)("li",{parentName:"ol"},"Open a browser to ",(0,o.kt)("inlineCode",{parentName:"li"},"http://127.0.0.1:8000/admin/")," to open the admin site"),(0,o.kt)("li",{parentName:"ol"},"Create a few test objects of each type."),(0,o.kt)("li",{parentName:"ol"},"Open tab to ",(0,o.kt)("inlineCode",{parentName:"li"},"http://127.0.0.1:8000")," to see the main site, with your new objects.")),(0,o.kt)("h2",{id:"install-and-configure-the-django-oidc-library"},"Install and configure the Django OIDC library"),(0,o.kt)("p",null,"Now that we've installed and configured Keycloak, we need to setup Django to replace the native authentication method provided by the framework. The first task is to install a library that is compatible with Keycloak's OIDC implementation."),(0,o.kt)("p",null,"The ",(0,o.kt)("a",{parentName:"p",href:"https://mozilla-django-oidc.readthedocs.io/"},"mozilla-django-oidc")," library provides an easy way to integrate Keycloak (or any OpenID Connect-compliant identity provider) with your Django app. It abstracts many of the complexities of integrating authentication and authorization. Here's how you can set it up:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"Install the Package"),":\nInstall the ",(0,o.kt)("inlineCode",{parentName:"p"},"mozilla-django-oidc")," package using pip:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"pip install mozilla-django-oidc\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"Configure Django Settings"),":\nUpdate your Django app's ",(0,o.kt)("inlineCode",{parentName:"p"},"settings.py")," to include the necessary configurations for ",(0,o.kt)("inlineCode",{parentName:"p"},"mozilla-django-oidc"),":"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-python"},"INSTALLED_APPS = [\n    # ...\n    'django.contrib.auth',\n    'mozilla_django_oidc',  # Load after django.contrib.auth\n    # ...\n]\n\nAUTHENTICATION_BACKENDS = (\n    'mozilla_django_oidc.auth.OIDCAuthenticationBackend',\n    # ...\n)\n\nOIDC_RP_CLIENT_ID = 'your-client-id'\nOIDC_RP_CLIENT_SECRET = 'your-client-secret'\nOIDC_OP_AUTHORIZATION_ENDPOINT = 'https://keycloak-url/auth/realms/your-realm/protocol/openid-connect/auth'\nOIDC_OP_TOKEN_ENDPOINT = 'https://keycloak-url/auth/realms/your-realm/protocol/openid-connect/token'\nOIDC_OP_USER_ENDPOINT = 'https://keycloak-url/auth/realms/your-realm/protocol/openid-connect/userinfo'\nOIDC_OP_JWKS_ENDPOINT = 'https://keycloak-url/auth/realms/your-realm/protocol/openid-connect/certs'\nOIDC_RP_SIGN_ALGO = 'RS256'\n\nLOGIN_URL = 'oidc_authentication_init'\nLOGOUT_REDIRECT_URL = '/'\nLOGIN_REDIRECT_URL = '/'\n")),(0,o.kt)("p",{parentName:"li"},"Replace ",(0,o.kt)("inlineCode",{parentName:"p"},"your-client-id"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"your-client-secret"),", and the Keycloak URLs with your actual Keycloak configurations.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"Add URLs"),":\nUpdate your Django app's ",(0,o.kt)("inlineCode",{parentName:"p"},"urls.py")," to include the authentication URLs provided by ",(0,o.kt)("inlineCode",{parentName:"p"},"mozilla-django-oidc"),":"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-python"},"urlpatterns += [\n    path('oidc/', include('mozilla_django_oidc.urls')),\n]\n")))),(0,o.kt)("h2",{id:"using-it-in-your-app"},"Using it in your app"),(0,o.kt)("h3",{id:"protect-your-views"},"Protect your views"),(0,o.kt)("p",null,"Use Decorators for Access Control. You can now use the ",(0,o.kt)("inlineCode",{parentName:"p"},"@oidc_protected")," decorator to protect views that require authentication and potentially specific roles:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"from mozilla_django_oidc.decorators import oidc_protected\n\n@oidc_protected\ndef protected_view(request):\n    # Your view logic\n")),(0,o.kt)("h3",{id:"accessing-user-information"},"Accessing user information"),(0,o.kt)("p",null,"You can access user information after authentication using the ",(0,o.kt)("inlineCode",{parentName:"p"},"request.oidc_user")," attribute. For example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"def profile_view(request):\n    user_info = request.oidc_user.userinfo\n    # Access user_info['sub'], user_info['email'], etc.\n    # Your view logic\n")),(0,o.kt)("p",null,"By default, ",(0,o.kt)("inlineCode",{parentName:"p"},"mozilla-django-oidc")," looks up a Django user matching the email field to the email address returned in the user info data from Keycloak."),(0,o.kt)("p",null,"If a user logs into your site and doesn\u2019t already have an account, by default, ",(0,o.kt)("inlineCode",{parentName:"p"},"mozilla-django-oidc")," will create a new Django user account. It will create the User instance filling in the username (hash of the email address) and email fields."),(0,o.kt)("h4",{id:"use-username-rather-than-email"},"Use Username rather than Email"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"mozilla-django-oidc")," defaults to setting up Django users using the email address as the user name from keycloak was required. Fortunately, ",(0,o.kt)("inlineCode",{parentName:"p"},"preferred_username")," is set up by default in Keycloak as a claim. The claim can used by overriding the ",(0,o.kt)("inlineCode",{parentName:"p"},"OIDCAuthenticationBackend")," class in ",(0,o.kt)("inlineCode",{parentName:"p"},"mozilla_django_oidc.auth")," and referring to this in ",(0,o.kt)("inlineCode",{parentName:"p"},"AUTHENTICATION_BACKENDS")," as below:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"\n# Classes to override default OIDCAuthenticationBackend (Keycloak authentication)\nfrom mozilla_django_oidc.auth import OIDCAuthenticationBackend\n\nclass KeycloakOIDCAuthenticationBackend(OIDCAuthenticationBackend):\n\n def create_user(self, claims):\n     \"\"\" Overrides Authentication Backend so that Django users are\n         created with the keycloak preferred_username.\n         If nothing found matching the email, then try the username.\n     \"\"\"\n     user = super(KeycloakOIDCAuthenticationBackend, self).create_user(claims)\n     user.first_name = claims.get('given_name', '')\n     user.last_name = claims.get('family_name', '')\n     user.email = claims.get('email')\n     user.username = claims.get('preferred_username')\n     user.save()\n     return user\n\n def filter_users_by_claims(self, claims):\n     \"\"\" Return all users matching the specified email.\n         If nothing found matching the email, then try the username\n     \"\"\"\n     email = claims.get('email')\n     preferred_username = claims.get('preferred_username')\n\n     if not email:\n         return self.UserModel.objects.none()\n     users = self.UserModel.objects.filter(email__iexact=email)\n\n     if len(users) < 1:\n         if not preferred_username:\n             return self.UserModel.objects.none()\n         users = self.UserModel.objects.filter(username__iexact=preferred_username)\n     return users\n\n def update_user(self, user, claims):\n     user.first_name = claims.get('given_name', '')\n     user.last_name = claims.get('family_name', '')\n     user.email = claims.get('email')\n     user.username = claims.get('preferred_username')\n     user.save()\n     return user\n")),(0,o.kt)("p",null,"In settings.py, overide the new library you have just added in AUTHENTICATION_BACKENDS :"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},' # mozilla_django_oidc - Keycloak authentication\n "fragalysis.auth.KeycloakOIDCAuthenticationBackend",\n')),(0,o.kt)("h3",{id:"logging-out"},"Logging out"),(0,o.kt)("p",null,"You can use the ",(0,o.kt)("inlineCode",{parentName:"p"},"@oidc_logout")," decorator to log the user out of both your app and Keycloak:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"from mozilla_django_oidc.decorators import oidc_logout\n\n@oidc_logout\ndef logout_view(request):\n    # Your logout view logic\n")),(0,o.kt)("h2",{id:"add-support-for-django-rest-framework"},"Add support for Django Rest Framework"),(0,o.kt)("p",null,"Django Rest Framework (DRF) is a flexible toolkit built on top of Django, specifically designed for building RESTful APIs."),(0,o.kt)("p",null,"If you want DRF to authenticate users based on an OAuth access token provided in the Authorization header, you can use the DRF-specific authentication class which ships with the package."),(0,o.kt)("p",null,"Add this to your settings:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"REST_FRAMEWORK = {\n    'DEFAULT_AUTHENTICATION_CLASSES': [\n        'mozilla_django_oidc.contrib.drf.OIDCAuthentication',\n        'rest_framework.authentication.SessionAuthentication',\n        # other authentication classes, if needed\n    ],\n}\n")),(0,o.kt)("p",null,"Note that this only takes care of authenticating against an access token, and provides no options to create or renew tokens."),(0,o.kt)("p",null,"If you\u2019ve created a custom Django OIDCAuthenticationBackend and added that to your AUTHENTICATION_BACKENDS, the DRF class should be smart enough to figure that out. Alternatively, you can manually set the OIDC backend to use:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"OIDC_DRF_AUTH_BACKEND = 'mozilla_django_oidc.auth.OIDCAuthenticationBackend'\n")))}p.isMDXComponent=!0}}]);