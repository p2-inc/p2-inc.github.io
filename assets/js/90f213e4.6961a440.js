"use strict";(self.webpackChunkphasetwo_docs=self.webpackChunkphasetwo_docs||[]).push([[1071],{28453:(e,t,n)=>{n.d(t,{R:()=>r,x:()=>a});var s=n(96540);const i={},o=s.createContext(i);function r(e){const t=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),s.createElement(o.Provider,{value:t},e.children)}},76191:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>l,default:()=>p,frontMatter:()=>a,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"securing-applications/sveltekit","title":"SvelteKit","description":"View a live deployed version.","source":"@site/docs/securing-applications/sveltekit.mdx","sourceDirName":"securing-applications","slug":"/securing-applications/sveltekit","permalink":"/docs/securing-applications/sveltekit","draft":false,"unlisted":false,"editUrl":"https://github.com/p2-inc/phasetwo-docs/tree/main/docs/securing-applications/sveltekit.mdx","tags":[],"version":"current","frontMatter":{"id":"sveltekit","title":"SvelteKit"},"sidebar":"docs","previous":{"title":"Remix","permalink":"/docs/securing-applications/remix"},"next":{"title":"Angular","permalink":"/docs/securing-applications/angular"}}');var i=n(74848),o=n(28453),r=n(81945);const a={id:"sveltekit",title:"SvelteKit"},l=void 0,c={},d=[...r.RM];function h(e){const t={a:"a",p:"p",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(t.p,{children:["View a ",(0,i.jsx)(t.a,{href:"https://phasetwo-sveltekit-example.vercel.app/",children:"live deployed version"}),"."]}),"\n","\n",(0,i.jsx)(r.Ay,{})]})}function p(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},81945:(e,t,n)=>{n.d(t,{Ay:()=>a,RM:()=>o});var s=n(74848),i=n(28453);const o=[];function r(e){const t={a:"a",admonition:"admonition",code:"code",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.admonition,{type:"info",children:(0,s.jsx)(t.p,{children:"We will use the Phase Two SvelteKit example code here, but the logic could easily be applied to any existing application."})}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["Clone the Phase Two ",(0,s.jsx)(t.a,{href:"https://github.com/p2-inc/examples/",children:"example repo"}),"."]}),"\n",(0,s.jsxs)(t.li,{children:["Open the SvelteKit ",(0,s.jsx)(t.a,{href:"https://github.com/p2-inc/examples/tree/main/frameworks/sveltekit",children:"folder"})," within ",(0,s.jsx)(t.code,{children:"/frameworks/sveltekit"}),"."]}),"\n",(0,s.jsxs)(t.li,{children:["Run ",(0,s.jsx)(t.code,{children:"npm install"})," and then ",(0,s.jsx)(t.code,{children:"npm run dev"}),". This example leverages ",(0,s.jsx)(t.a,{href:"https://github.com/nextauthjs/next-auth",children:"@auth/sveltekit"})," to provide HOC support."]}),"\n",(0,s.jsxs)(t.li,{children:["The project makes use of the following SvelteKit items: hooks, components, layout, and ",(0,s.jsx)(t.code,{children:"@auth/sveltekit"})," module. We'll review each in kind."]}),"\n",(0,s.jsxs)(t.li,{children:["We'll review where we configure out Keycloak instance. Open the ",(0,s.jsx)(t.code,{children:"src/auth.ts"})," file. This is a server only file. We will be updating a few values from the prior section where we set up our OIDC client. Taking the values from the OIDC Client Config section, set those values in the code. While it is recommended to use Environment variables for the secret, for the purpose of this tutorial, paste in the ",(0,s.jsx)(t.strong,{children:"Client secret"})," from the OIDC client creation section for the value of ",(0,s.jsx)(t.code,{children:"clientSecret"}),"."]}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-tsx",children:'// Use Environment Variables AUTH_SECRET in prod\nconst authjsSecret =\n  "f18d48ce9bea32e44b5591b2c89185729d4559435f77ca76872a83a0850563a4";\n\nconst realm = "shared-deployment-001";\n\nconst kcConfig = {\n  // Use Environment Variables AUTH_KEYCLOAK_ISSUER in prod\n  issuer: `https://usw2.auth.ac/auth/realms/${realm}`,\n  // Paste "Client id" here. Use Environment Variables AUTH_KEYCLOAK_ID in prod\n  clientId: "reg-example-1",\n  // Paste "Client secret" here. Use Environment Variables AUTH_KEYCLOAK_ISSUER in prod\n  clientSecret: "CLIENT_SECRET",\n};\n'})}),"\n",(0,s.jsxs)(t.p,{children:["Those are used to popluate the config for the provider ",(0,s.jsx)(t.code,{children:"Keycloak"}),":"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-tsx",children:"export const { handle, signIn, signOut } = SvelteKitAuth({\n  trustHost: true,\n  secret: authjsSecret,\n  providers: [Keycloak(kcConfig)],\n});\n"})}),"\n",(0,s.jsxs)(t.ol,{start:"6",children:["\n",(0,s.jsxs)(t.li,{children:["Next, let's review the hooks (",(0,s.jsx)(t.code,{children:"src/hooks.server.ts"}),") file. This imports the ",(0,s.jsx)(t.code,{children:"handle"})," method by the ",(0,s.jsx)(t.code,{children:"src/auth.ts"})," and re-exports it. This allows the hooks to act as a middleware and include the authentication status of the user in each request."]}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-tsx",children:'export { handle } from "./auth.js";\n'})}),"\n",(0,s.jsxs)(t.ol,{start:"7",children:["\n",(0,s.jsxs)(t.li,{children:["To retrieve the authentication status of the user in server-side rendering on the index route, it's using the ",(0,s.jsx)(t.code,{children:"+layout.server.ts"})," file. It retrieves the authentication status via the ",(0,s.jsx)(t.code,{children:"getSession"})," function from ",(0,s.jsx)(t.a,{href:"https://kit.svelte.dev/docs/types#app-locals",children:"SvelteKit Locals"})," set by ",(0,s.jsx)(t.code,{children:"src/hook.server.ts"}),"."]}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-tsx",children:'import type { LayoutServerLoad } from "./$types.js";\n\nexport const load: LayoutServerLoad = async (event) => {\n  const session = await event.locals.getSession();\n  return {\n    session,\n  };\n};\n'})}),"\n",(0,s.jsxs)(t.ol,{start:"8",children:["\n",(0,s.jsxs)(t.li,{children:["The server-side authentication data is then accessed inside the ",(0,s.jsx)(t.code,{children:"+page.svelte"}),", and then passed onto the user (",(0,s.jsx)(t.code,{children:"src/components/user.svelte"}),") component as follows:"]}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-html",children:'<script lang="ts">\n  import User from "$components/user.svelte";\n  import type { LayoutServerData } from "./$types.js";\n\n  export let data: LayoutServerData;\n<\/script>\n\n// ... Rest of the index route ... // <User data={{ user: data?.session?.user,\nstatus: Boolean(data?.session), }} />\n'})}),"\n",(0,s.jsxs)(t.p,{children:["The props, ",(0,s.jsx)(t.strong,{children:"user"})," and ",(0,s.jsx)(t.strong,{children:"status"})," represent the user information object and whether the user is signed in, respectively."]}),"\n",(0,s.jsxs)(t.ol,{start:"9",children:["\n",(0,s.jsxs)(t.li,{children:["At this point our entire application will be able to access all information and methods needed to perform authentication. View ",(0,s.jsx)(t.code,{children:"src/components/user.svelte"})," for exactly how the code is authenticating your user. The sections rendering the ",(0,s.jsx)(t.strong,{children:"Log in"})," and ",(0,s.jsx)(t.strong,{children:"Log out"})," buttons are conditional areas based on the authenticated context. The buttons invoke server-side APIs provided by ",(0,s.jsx)(t.code,{children:"@auth/sveltekit"}),"."]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"The logic using the authenticator to conditionally determine the Authenticated state, can be used to secure routes, components, and more."}),"\n",(0,s.jsxs)(t.ol,{start:"10",children:["\n",(0,s.jsxs)(t.li,{children:["Open ",(0,s.jsx)(t.a,{href:"http://localhost:3000",children:"localhost:3000"}),". You will see the Phase Two example landing page. You current state should be ",(0,s.jsx)(t.strong,{children:"Not authenticated"}),". Click ",(0,s.jsx)(t.strong,{children:"Log In"}),". This will redirect you to your login page."]}),"\n"]}),"\n",(0,s.jsx)(t.admonition,{type:"info",children:(0,s.jsx)(t.p,{children:"Use the non-admin user created in the previous section to sign in."})}),"\n",(0,s.jsxs)(t.ol,{start:"11",children:["\n",(0,s.jsxs)(t.li,{children:["Enter the credentials of the non-admin user you created. Click ",(0,s.jsx)(t.strong,{children:"Submit"}),". You will then be redirected to the application. The Phase Two example landing page now loads your ",(0,s.jsx)(t.strong,{children:"Authenticated"})," state, displaying your user's email and name."]}),"\n",(0,s.jsx)(t.li,{children:"Neat! If you clear the browser state for that tab, then you will have to be redirected away to sign-in again."}),"\n"]})]})}function a(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(r,{...e})}):r(e)}}}]);